<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å –∑–∞–º–æ–≤–ª–µ–Ω—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
   /* ===== –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ ===== */
/* ===== –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ ===== */
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 0;
  color: #333;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
  font-weight: 600;
}

/* ===== –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É ===== */
.login-box {
  width: 100%;
  max-width: 360px;
  background: #fff;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
}

.login-box h2 {
  text-align: center;
  margin-bottom: 25px;
  color: #222;
  font-weight: 600;
}

.login-box form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.login-box input {
  padding: 12px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  outline: none;
  transition: border-color 0.3s ease;
}

.login-box input:focus {
  border-color: #0078d7;
}

.login-box button {
  padding: 12px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  background: #0078d7;
  color: #fff;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.3s ease;
}

.login-box button:hover {
  background: #005fa3;
}

#loginError {
  text-align: center;
  color: #d9534f;
  margin-top: 10px;
  font-size: 14px;
}

/* ===== –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ===== */
#adminPanel {
  background: #f9f9fb;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: none;
}

.controls, .export-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}

input, button {
  padding: 8px 12px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

input[type="date"], input[type="text"] {
  outline: none;
  transition: border-color 0.3s ease;
}

input[type="date"]:focus, input[type="text"]:focus {
  border-color: #4a90e2;
}

button {
  background: #4a90e2;
  color: #fff;
  border: none;
  cursor: pointer;
  transition: background 0.3s ease;
}

button:hover {
  background: #357ab8;
}

.delete-btn {
  background: #d9534f;
}

.delete-btn:hover {
  background: #b52b27;
}

.save-btn {
  background: #28a745;
}

.save-btn:hover {
  background: #1e7e34;
}

img {
  max-width: 80px;
  border-radius: 5px;
}

#ordersTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#ordersTable th, #ordersTable td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

#ordersTable th {
  background: #4a90e2;
  color: #fff;
}

#ordersTable tr:nth-child(even) {
  background: #f2f6fc;
}

#ordersTable tr:hover {
  background: #e6f0fa;
}

/* ===== –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å ===== */
@media (max-width: 768px) {
  .controls, .export-buttons {
    flex-direction: column;
    align-items: stretch;
  }

  input, button {
    width: 100%;
    font-size: 14px;
  }

  #ordersTable th, #ordersTable td {
    padding: 8px;
    font-size: 14px;
  }

  img {
    max-width: 60px;
  }
}

@media (max-width: 480px) {
  body {
    padding: 10px;
  }

  h1 {
    font-size: 20px;
  }

  .login-box {
    padding: 20px;
    border-radius: 8px;
  }

  .login-box h2 {
    font-size: 20px;
  }

  .login-box input, .login-box button {
    font-size: 14px;
    padding: 10px;
  }

  #ordersTable, .controls, .export-buttons {
    font-size: 13px;
  }

  #ordersTable th, #ordersTable td {
    padding: 6px;
  }

  button {
    padding: 6px 10px;
    font-size: 13px;
  }
}
/* ===== –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ ===== */
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 20px;
  color: #333;
  min-height: 100vh;
  display: block; /* –ø—Ä–∏–±—Ä–∞–ª–∏ flex –¥–ª—è –≤—Å—å–æ–≥–æ body */
}

/* –¶–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è login-box */
body.login-active {
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ===== –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É ===== */
.login-box {
  width: 100%;
  max-width: 360px;
  background: #fff;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  margin: auto;
}

/* ===== –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ===== */
#adminPanel {
  background: #f9f9fb;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: none;
  max-width: 1200px;
  margin: 20px auto;
  overflow-x: auto;   /* –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
  overflow-y: auto;   /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
}

/* ===== –ö–Ω–æ–ø–∫–∏ —Ç–∞ —ñ–Ω—à–µ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è —è–∫ –±—É–ª–æ ===== */
.controls, .export-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}

#ordersTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}



/* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —Ç–∞–±–ª–∏—Ü—è */
#ordersTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#ordersTable th, #ordersTable td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

#ordersTable th {
  background: #4a90e2;
  color: #fff;
}

/* üì± –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å: –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —É –∫–∞—Ä—Ç–∫–∏ */
@media (max-width: 768px) {
  #ordersTable, #ordersTable thead, #ordersTable tbody, #ordersTable th, #ordersTable td, #ordersTable tr {
    display: block;
    width: 100%;
  }

  #ordersTable thead {
    display: none; /* –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
  }

  #ordersTable tr {
    margin-bottom: 15px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    padding: 10px;
  }

  #ordersTable td {
    text-align: left;
    border: none;
    padding: 8px;
    position: relative;
  }

  #ordersTable td::before {
    content: attr(data-label); /* –ø–æ–∫–∞–∑—É—î –Ω–∞–∑–≤—É –∫–æ–ª–æ–Ω–∫–∏ */
    font-weight: bold;
    display: block;
    margin-bottom: 4px;
    color: #4a90e2;
  }
}
@media (max-width: 768px) {
  #ordersTable, #ordersTable thead, #ordersTable tbody, #ordersTable th, #ordersTable td, #ordersTable tr {
    display: block;
    width: 100%;
  }

  #ordersTable thead {
    display: none; /* –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
  }

  #ordersTable tr {
    margin-bottom: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 15px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  #ordersTable tr:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
  }

  #ordersTable td {
    text-align: left;
    border: none;
    padding: 8px 0;
    position: relative;
  }

  #ordersTable td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #4a90e2;
    display: block;
    margin-bottom: 4px;
    font-size: 14px;
  }

  /* –§–æ—Ç–æ —É –∫–∞—Ä—Ç—Ü—ñ */
  #ordersTable td img {
    max-width: 100px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  /* –ö–Ω–æ–ø–∫–∏ –¥—ñ–π */
  .save-btn, .delete-btn {
    display: inline-block;
    margin-top: 8px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
  }

  .save-btn {
    background: #28a745;
    color: #fff;
  }

  .save-btn:hover {
    background: #1e7e34;
  }

  .delete-btn {
    background: #d9534f;
    color: #fff;
  }

  .delete-btn:hover {
    background: #b52b27;
  }
}

@media (max-width: 768px) {
  #ordersTable tr {
    margin-bottom: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 15px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 6px solid transparent; /* –∞–∫—Ü–µ–Ω—Ç–Ω–∞ –ª—ñ–Ω—ñ—è */
  }

  #ordersTable tr:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
  }

  /* –°—Ç–∞—Ç—É—Å–∏ */
  #ordersTable tr.status-paid {
    border-left-color: #28a745; /* –∑–µ–ª–µ–Ω–∏–π */
  }

  #ordersTable tr.status-pending {
    border-left-color: #ffc107; /* –∂–æ–≤—Ç–∏–π */
  }

  #ordersTable tr.status-cancelled {
    border-left-color: #dc3545; /* —á–µ—Ä–≤–æ–Ω–∏–π */
  }

  /* –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å—É */
  .order-status {
    font-weight: 600;
    padding: 6px 10px;
    border-radius: 6px;
    display: inline-block;
    margin-top: 8px;
  }

  .order-status.paid {
    background: #28a745;
    color: #fff;
  }

  .order-status.pending {
    background: #ffc107;
    color: #333;
  }

  .order-status.cancelled {
    background: #dc3545;
    color: #fff;
  }
}
  </style>
</head>
<body>

<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è -->
<div class="login-box" id="loginBox">
  <h2>–í—Ö—ñ–¥</h2>
  <form onsubmit="login(); return false;">
    <input type="text" id="username" placeholder="–õ–æ–≥—ñ–Ω" required autocomplete="username">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required autocomplete="current-password">
    <button type="submit">–£–≤—ñ–π—Ç–∏</button>
  </form>
    <p id="loginError"></p>
</div>





<!-- –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å -->
<div id="adminPanel">
  <h1>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

  <!-- –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
  <div class="controls">
    <label for="filterDate">–§—ñ–ª—å—Ç—Ä –∑–∞ –¥–∞—Ç–æ—é:</label>
    <input type="date" id="filterDate" name="filterDate">

    <button type="button" onclick="filterOrders()">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>

    <label for="searchInput">–ü–æ—à—É–∫:</label>
    <input type="text" id="searchInput" name="searchInput" placeholder="–Ü–º‚Äô—è –∞–±–æ —Ç–µ–ª–µ—Ñ–æ–Ω">

    <button type="button" onclick="searchOrders()">–ü–æ—à—É–∫</button>

    <button type="button" onclick="exportToExcel()">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤ Excel</button>
    <button type="button" onclick="exportToXLSX()">–ï–∫—Å–ø–æ—Ä—Ç —É XLSX</button>
    <button type="button" onclick="exportToPDF()">–ï–∫—Å–ø–æ—Ä—Ç —É PDF</button>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ –µ–∫—Å–ø–æ—Ä—Ç—É -->
  <div class="export-buttons">
    <button type="button" onclick="exportToXLSX()">–ï–∫—Å–ø–æ—Ä—Ç —É—Å—ñ—Ö —É XLSX</button>
    <button type="button" onclick="exportToPDF()">–ï–∫—Å–ø–æ—Ä—Ç —É—Å—ñ—Ö —É PDF</button>
    <button type="button" onclick="exportToXLSX(true)">–ï–∫—Å–ø–æ—Ä—Ç –≤–∏–±—Ä–∞–Ω–∏—Ö —É XLSX</button>
    <button type="button" onclick="exportToPDF(true)">–ï–∫—Å–ø–æ—Ä—Ç –≤–∏–±—Ä–∞–Ω–∏—Ö —É PDF</button>
    <button type="button" onclick="toggleSelectAll(true)">–í–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ</button>
    <button type="button" onclick="toggleSelectAll(false)">–ó–Ω—è—Ç–∏ –≤—Å—ñ</button>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü—è –∑–∞–º–æ–≤–ª–µ–Ω—å -->
  <table id="ordersTable">
    <thead>
      <tr>
        <th scope="col">–§–æ—Ç–æ</th>
        <th scope="col">–Ü–º‚Äô—è</th>
        <th scope="col">–¢–µ–ª–µ—Ñ–æ–Ω</th>
        <th scope="col">Email</th>
        <th scope="col">–î–æ—Å—Ç–∞–≤–∫–∞</th>
        <th scope="col">–ú—ñ—Å—Ç–æ</th>
        <th scope="col">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</th>
        <th scope="col">‚Ññ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</th>
        <th scope="col">–û–ø–ª–∞—Ç–∞</th>
        <th scope="col">–¢–æ–≤–∞—Ä–∏</th>
        <th scope="col">–°—É–º–∞</th>
        <th scope="col">–î–∞—Ç–∞</th>
        <th scope="col">–î—ñ—ó</th>
      </tr>
    </thead>
    <tbody>
      <!-- —Ä—è–¥–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω—å –±—É–¥—É—Ç—å –¥–æ–¥–∞–≤–∞—Ç–∏—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
    </tbody>
  </table>
</div>
  
 <script>
  const CONFIG = {
  API_URL: "https://shop-my-86on.onrender.com/api/admin/login"
};


  

  let allOrders = [];

  // ===== –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è =====
  const login = async () => {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  try {
    const res = await fetch("https://shop-my-86on.onrender.com/api/orders/api/admin/login", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    if (!res.ok) throw new Error('Login failed');
    const { token } = await res.json();

    localStorage.setItem('token', token);
    togglePanels(true);
    loadOrders();
  } catch (err) {
    showMessage('loginError', '–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å', 'red');
  }
};

  const togglePanels = isLoggedIn => {
    document.getElementById('loginBox').style.display = isLoggedIn ? 'none' : 'block';
    document.getElementById('adminPanel').style.display = isLoggedIn ? 'block' : 'none';
  };

  const showMessage = (elementId, message, color = 'black') => {
    const el = document.getElementById(elementId);
    if (el) { el.textContent = message; el.style.color = color; }
  };

  // ===== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å =====
 const loadOrders = async () => {
  try {
    const token = localStorage.getItem('token');
    const res = await fetch(CONFIG.API_URL, {
      headers: { 'Authorization': 'Bearer ' + token }
    });

    const response = await res.json(); // —á–∏—Ç–∞—î–º–æ —Ç—ñ–ª–æ –ª–∏—à–µ –æ–¥–∏–Ω —Ä–∞–∑

    // —è–∫—â–æ –±–µ–∫–µ–Ω–¥ –ø–æ–≤–µ—Ä—Ç–∞—î –º–∞—Å–∏–≤ –Ω–∞–ø—Ä—è–º—É:
    allOrders = response;

    // —è–∫—â–æ –±–µ–∫–µ–Ω–¥ –ø–æ–≤–µ—Ä—Ç–∞—î –æ–±‚Äô—î–∫—Ç { orders: [...] }:
    // allOrders = response.orders;

    renderOrders(allOrders);
  } catch (err) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', err);
    showTableError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å');
  }
};

  const showTableError = msg => {
    document.querySelector('#ordersTable tbody').innerHTML =
      `<tr><td colspan="13" style="color:red;text-align:center;">${msg}</td></tr>`;
  };

  // ===== –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ =====
  const renderOrders = orders => {
    const tbody = document.querySelector('#ordersTable tbody');
    if (!Array.isArray(orders)) {
      showTableError('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö');
      return;
    }
    tbody.innerHTML = orders.map(o => `
      <tr data-id="${o.id}">
        <td>
          <img src="${o.photo}" alt="–§–æ—Ç–æ" id="photo-${o.id}">
          <br><input type="file" accept="image/*" onchange="updatePhoto(${o.id}, event)">
        </td>
        <td contenteditable="true">${o.name}</td>
        <td>${o.phone}</td>
        <td>${o.email}</td>
        <td>${o.delivery}</td>
        <td>${o.city}</td>
        <td>${o.branch}</td>
        <td>${o.branchNumber}</td>
        <td>${o.payment}</td>
        <td contenteditable="true">${o.items}</td>
        <td contenteditable="true">${o.total}</td>
        <td>${o.date}</td>
        <td>
          <button class="save-btn" onclick="saveOrder(${o.id})">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <button class="delete-btn" onclick="deleteOrder(${o.id})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </td>
      </tr>
    `).join('');
  };

  // ===== –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ–æ—Ç–æ =====
  const updatePhoto = (id, event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById(`photo-${id}`).src = e.target.result;
      const order = allOrders.find(o => o.id === id);
      if (order) order.photo = e.target.result;
    };
    reader.readAsDataURL(file);
  };

  // ===== –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ =====
  const filterOrders = () => {
    const selectedDate = document.getElementById('filterDate').value;
    if (!selectedDate) return renderOrders(allOrders);
    const filtered = allOrders.filter(o =>
      new Date(o.date).toISOString().slice(0, 10) === selectedDate
    );
    renderOrders(filtered);
  };

  // ===== –ü–æ—à—É–∫ =====
  const searchOrders = () => {
    const query = document.getElementById('searchInput').value.toLowerCase();
    if (!query) return renderOrders(allOrders);
    const filtered = allOrders.filter(o =>
      o.name.toLowerCase().includes(query) || o.phone.toLowerCase().includes(query)
    );
    renderOrders(filtered);
  };

  // ===== –ï–∫—Å–ø–æ—Ä—Ç —É CSV =====
  const exportToExcel = () => {
    const header = '–Ü–º‚Äô—è,–¢–µ–ª–µ—Ñ–æ–Ω,Email,–î–æ—Å—Ç–∞–≤–∫–∞,–¢–æ–≤–∞—Ä–∏,–°—É–º–∞,–î–∞—Ç–∞\n';
    const rows = allOrders.map(o =>
      `"${o.name}","${o.phone}","${o.email}","${o.delivery}","${o.items}","${o.total}","${o.date}"`
    ).join('\n');

    const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'orders.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // ===== –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤ =====
  const sendRequest = async (url, method, body = null) => {
    const token = localStorage.getItem('token');
    const options = {
      method,
      headers: { 'Authorization': 'Bearer ' + token }
    };
    if (body) {
      options.headers['Content-Type'] = 'application/json';
      options.body = JSON.stringify(body);
    }
    return fetch(url, options);
  };

  // ===== –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è =====
  const saveOrder = async (id) => {
    const row = document.querySelector(`#ordersTable tbody tr[data-id="${id}"]`);
    const updatedOrder = {
      name: row.cells[1].textContent.trim(),
      phone: row.cells[2].textContent.trim(),
      email: row.cells[3].textContent.trim(),
      delivery: row.cells[4].textContent.trim(),
      city: row.cells[5].textContent.trim(),
      branch: row.cells[6].textContent.trim(),
      branchNumber: row.cells[7].textContent.trim(),
      payment: row.cells[8].textContent.trim(),
      items: row.cells[9].textContent.trim(),
      total: row.cells[10].textContent.trim(),
      date: row.cells[11].textContent.trim(),
      photo: allOrders.find(o => o.id === id)?.photo
    };

    try {
      const res = await sendRequest(`${CONFIG.API_URL}/${id}`, 'PUT', updatedOrder);
      if (res.ok) {
        showMessage('loginError', '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ ‚úÖ', 'green');
        allOrders = allOrders.map(o => o.id === id ? updatedOrder : o);
      } else {
        showMessage('loginError', '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ‚ùå', 'red');
      }
    } catch (err) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', err);
      showMessage('loginError', '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ ‚ùå', 'red');
    }
  };

  // ===== –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è =====
  const deleteOrder = async (id) => {
    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?')) return;
    try {
      const res = await sendRequest(`${CONFIG.API_URL}/${id}`, 'DELETE');
      if (res.ok) {
        allOrders = allOrders.filter(o => o.id !== id);
        renderOrders(allOrders);
        showMessage('loginError', '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ üóëÔ∏è', 'green');
      } else {
        showMessage('loginError', '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è ‚ùå', 'red');
      }
    } catch (err) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è:', err);
      showMessage('loginError', '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ ‚ùå', 'red');
    }
  };


  // ===== –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫ =====
let sortDirection = true; // true = ASC, false = DESC

const sortTable = (columnIndex) => {
  const sorted = [...allOrders].sort((a, b) => {
    const valA = Object.values(a)[columnIndex];
    const valB = Object.values(b)[columnIndex];
    if (!isNaN(valA) && !isNaN(valB)) {
      return sortDirection ? valA - valB : valB - valA;
    }
    return sortDirection
      ? valA.toString().localeCompare(valB.toString())
      : valB.toString().localeCompare(valA.toString());
  });
  sortDirection = !sortDirection;
  renderPaginatedOrders(sorted); // –ø–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω—ñ –∑ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—î—é
};

// –î–æ–¥–∞—î–º–æ —Å–ª—É—Ö–∞—á—ñ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∏
document.querySelectorAll("#ordersTable th").forEach((th, index) => {
  th.addEventListener("click", () => sortTable(index));
});

// ===== –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è =====
let currentPage = 1;
const rowsPerPage = 10;

const renderPaginatedOrders = (orders) => {
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const paginated = orders.slice(start, end);
  renderOrders(paginated);
  renderPaginationControls(orders.length);
};

const renderPaginationControls = (totalRows) => {
  const totalPages = Math.ceil(totalRows / rowsPerPage);
  let controls = document.getElementById("paginationControls");
  if (!controls) {
    controls = document.createElement("div");
    controls.id = "paginationControls";
    controls.className = "pagination";
    document.getElementById("adminPanel").appendChild(controls);
  }
  controls.innerHTML = `
    <button onclick="changePage(-1)" ${currentPage === 1 ? "disabled" : ""}>–ü–æ–ø–µ—Ä–µ–¥–Ω—è</button>
    <span>–°—Ç–æ—Ä—ñ–Ω–∫–∞ ${currentPage} –∑ ${totalPages}</span>
    <button onclick="changePage(1)" ${currentPage === totalPages ? "disabled" : ""}>–ù–∞—Å—Ç—É–ø–Ω–∞</button>
  `;
};

const changePage = (direction) => {
  currentPage += direction;
  renderPaginatedOrders(allOrders);
};


// ===== –û–Ω–æ–≤–∏—Ç–∏ —Å—É–º—É –≤ —Ä—è–¥–∫—É =====
const updateTotal = (id) => {
  const row = document.querySelector(`#ordersTable tr[data-id="${id}"]`);
  if (!row) return;

  const priceCell = row.querySelector(".price");
  const quantityCell = row.querySelector(".quantity");
  const totalCell = row.querySelector(`#total-${id}`);

  const price = parseFloat(priceCell?.textContent) || 0;
  const quantity = parseInt(quantityCell?.textContent) || 0;
  const total = price * quantity;

  if (totalCell) totalCell.textContent = total.toFixed(2);
};

// ===== –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –∞–±–æ –≤–∏–±—Ä–∞–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è =====
const getExportData = (selectedOnly = false) => {
  let orders = allOrders;

  if (selectedOnly) {
    const selectedIds = Array.from(document.querySelectorAll('.order-checkbox:checked'))
      .map(cb => parseInt(cb.dataset.id));
    orders = allOrders.filter(o => selectedIds.includes(o.id));
  }

  return orders.map(o => ({
    "–Ü–º‚Äô—è": o.name,
    "–¢–µ–ª–µ—Ñ–æ–Ω": o.phone,
    "Email": o.email,
    "–î–æ—Å—Ç–∞–≤–∫–∞": o.delivery,
    "–ú—ñ—Å—Ç–æ": o.city,
    "–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è": o.branch || "",
    "‚Ññ –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è": o.branchNumber || "",
    "–û–ø–ª–∞—Ç–∞": o.payment || "",
    "–¢–æ–≤–∞—Ä–∏": o.items,
    "–°—É–º–∞": o.total,
    "–î–∞—Ç–∞": o.date
  }));
};

// ===== –ï–∫—Å–ø–æ—Ä—Ç —É XLSX =====
const exportToXLSX = (selectedOnly = false) => {
  try {
    const data = getExportData(selectedOnly);
    if (data.length === 0) {
      alert("–ù–µ –≤–∏–±—Ä–∞–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!");
      return;
    }

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è");
    XLSX.writeFile(workbook, selectedOnly ? "selected_orders.xlsx" : "orders.xlsx");
  } catch (err) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É XLSX:", err);
    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —É XLSX");
  }
};

// ===== –ï–∫—Å–ø–æ—Ä—Ç —É PDF =====
const exportToPDF = (selectedOnly = false) => {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const data = getExportData(selectedOnly);
    if (data.length === 0) {
      alert("–ù–µ –≤–∏–±—Ä–∞–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!");
      return;
    }

    doc.setFontSize(16);
    doc.text(selectedOnly ? "–ó–≤—ñ—Ç –ø–æ –≤–∏–±—Ä–∞–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö" : "–ó–≤—ñ—Ç –ø–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö", 14, 20);

    const headers = [["–Ü–º‚Äô—è","–¢–µ–ª–µ—Ñ–æ–Ω","Email","–î–æ—Å—Ç–∞–≤–∫–∞","–ú—ñ—Å—Ç–æ","–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è","‚Ññ –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è","–û–ø–ª–∞—Ç–∞","–¢–æ–≤–∞—Ä–∏","–°—É–º–∞","–î–∞—Ç–∞"]];
    const rows = data.map(o => [
  o["–Ü–º‚Äô—è"] || "",
  o["–¢–µ–ª–µ—Ñ–æ–Ω"] || "",
  o["Email"] || "",
  o["–î–æ—Å—Ç–∞–≤–∫–∞"] || "",
  o["–ú—ñ—Å—Ç–æ"] || "",
  o["–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è"] || "",
  o["‚Ññ –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è"] || "",
  o["–û–ø–ª–∞—Ç–∞"] || "",
  String(o["–¢–æ–≤–∞—Ä–∏"] || ""), // –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ —É —Ç–µ–∫—Å—Ç
  String(o["–°—É–º–∞"] || ""),
  o["–î–∞—Ç–∞"] || ""
]);
const robotoBase64 = "—Ç—É—Ç_–¥–æ–≤–≥–∏–π_base64_—Ä—è–¥–æ–∫";
// –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ñ–∞–π–ª —à—Ä–∏—Ñ—Ç—É (ttf) —ñ –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —É base64 —á–µ—Ä–µ–∑ jsPDF fontconverter
doc.addFileToVFS("Roboto-Regular.ttf", robotoBase64);
doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
doc.setFont("Roboto");
const safeText = (val) => String(val || "").replace(/[\r\n]+/g, " ");
    doc.autoTable({
      head: headers,
      body: rows,
      startY: 30,
      styles: { fontSize: 10, cellPadding: 3 }
    });

    doc.save(selectedOnly ? "selected_orders.pdf" : "orders.pdf");
  } catch (err) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É PDF:", err);
    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —É PDF");
  }
};

// ===== –í–∏–±—Ä–∞—Ç–∏ / –∑–Ω—è—Ç–∏ –≤—Å—ñ —á–µ–∫–±–æ–∫—Å–∏ =====
const toggleSelectAll = (checked) => {
  document.querySelectorAll('.order-checkbox').forEach(cb => {
    cb.checked = checked;
  });
};

</script>

