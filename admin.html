<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å –∑–∞–º–æ–≤–ª–µ–Ω—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
 
/* ===== –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ ===== */
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 0;
  color: #333;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
  font-weight: 600;
}

/* ===== –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É ===== */
.login-box {
  width: 100%;
  max-width: 360px;
  background: #fff;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
}

.login-box h2 {
  text-align: center;
  margin-bottom: 25px;
  color: #222;
  font-weight: 600;
}

.login-box form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.login-box input {
  padding: 12px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  outline: none;
  transition: border-color 0.3s ease;
}

.login-box input:focus {
  border-color: #0078d7;
}

.login-box button {
  padding: 12px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  background: #0078d7;
  color: #fff;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.3s ease;
}

.login-box button:hover {
  background: #005fa3;
}

#loginError {
  text-align: center;
  color: #d9534f;
  margin-top: 10px;
  font-size: 14px;
}

/* ===== –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ===== */
#adminPanel {
  background: #f9f9fb;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: none;
}

.controls, .export-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}

input, button {
  padding: 8px 12px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

input[type="date"], input[type="text"] {
  outline: none;
  transition: border-color 0.3s ease;
}

input[type="date"]:focus, input[type="text"]:focus {
  border-color: #4a90e2;
}

button {
  background: #4a90e2;
  color: #fff;
  border: none;
  cursor: pointer;
  transition: background 0.3s ease;
}

button:hover {
  background: #357ab8;
}

.delete-btn {
  background: #d9534f;
}

.delete-btn:hover {
  background: #b52b27;
}

.save-btn {
  background: #28a745;
}

.save-btn:hover {
  background: #1e7e34;
}

img {
  max-width: 80px;
  border-radius: 5px;
}

#ordersTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#ordersTable th, #ordersTable td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

#ordersTable th {
  background: #4a90e2;
  color: #fff;
}

#ordersTable tr:nth-child(even) {
  background: #f2f6fc;
}

#ordersTable tr:hover {
  background: #e6f0fa;
}

/* ===== –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å ===== */
@media (max-width: 768px) {
  .controls, .export-buttons {
    flex-direction: column;
    align-items: stretch;
  }

  input, button {
    width: 100%;
    font-size: 14px;
  }

  #ordersTable th, #ordersTable td {
    padding: 8px;
    font-size: 14px;
  }

  img {
    max-width: 60px;
  }
}

@media (max-width: 480px) {
  body {
    padding: 10px;
  }

  h1 {
    font-size: 20px;
  }

  .login-box {
    padding: 20px;
    border-radius: 8px;
  }

  .login-box h2 {
    font-size: 20px;
  }

  .login-box input, .login-box button {
    font-size: 14px;
    padding: 10px;
  }

  #ordersTable, .controls, .export-buttons {
    font-size: 13px;
  }

  #ordersTable th, #ordersTable td {
    padding: 6px;
  }

  button {
    padding: 6px 10px;
    font-size: 13px;
  }
}
/* ===== –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ ===== */
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 20px;
  color: #333;
  min-height: 100vh;
  display: block; /* –ø—Ä–∏–±—Ä–∞–ª–∏ flex –¥–ª—è –≤—Å—å–æ–≥–æ body */
}

/* –¶–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è login-box */
body.login-active {
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ===== –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É ===== */
.login-box {
  width: 100%;
  max-width: 360px;
  background: #fff;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  margin: auto;
}

/* ===== –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ===== */
#adminPanel {
  background: #f9f9fb;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: none;
  max-width: 1200px;
  margin: 20px auto;
  overflow-x: auto;   /* –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
  overflow-y: auto;   /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
}

/* ===== –ö–Ω–æ–ø–∫–∏ —Ç–∞ —ñ–Ω—à–µ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è —è–∫ –±—É–ª–æ ===== */
.controls, .export-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}

#ordersTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}



/* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —Ç–∞–±–ª–∏—Ü—è */
#ordersTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#ordersTable th, #ordersTable td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

#ordersTable th {
  background: #4a90e2;
  color: #fff;
}

/* üì± –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å: –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —É –∫–∞—Ä—Ç–∫–∏ */
@media (max-width: 768px) {
  #ordersTable, #ordersTable thead, #ordersTable tbody, #ordersTable th, #ordersTable td, #ordersTable tr {
    display: block;
    width: 100%;
  }

  #ordersTable thead {
    display: none; /* –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
  }

  #ordersTable tr {
    margin-bottom: 15px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    padding: 10px;
  }

  #ordersTable td {
    text-align: left;
    border: none;
    padding: 8px;
    position: relative;
  }

  #ordersTable td::before {
    content: attr(data-label); /* –ø–æ–∫–∞–∑—É—î –Ω–∞–∑–≤—É –∫–æ–ª–æ–Ω–∫–∏ */
    font-weight: bold;
    display: block;
    margin-bottom: 4px;
    color: #4a90e2;
  }
}
@media (max-width: 768px) {
  #ordersTable, #ordersTable thead, #ordersTable tbody, #ordersTable th, #ordersTable td, #ordersTable tr {
    display: block;
    width: 100%;
  }

  #ordersTable thead {
    display: none; /* –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
  }

  #ordersTable tr {
    margin-bottom: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 15px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  #ordersTable tr:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
  }

  #ordersTable td {
    text-align: left;
    border: none;
    padding: 8px 0;
    position: relative;
  }

  #ordersTable td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #4a90e2;
    display: block;
    margin-bottom: 4px;
    font-size: 14px;
  }

  /* –§–æ—Ç–æ —É –∫–∞—Ä—Ç—Ü—ñ */
  #ordersTable td img {
    max-width: 100px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  /* –ö–Ω–æ–ø–∫–∏ –¥—ñ–π */
  .save-btn, .delete-btn {
    display: inline-block;
    margin-top: 8px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
  }

  .save-btn {
    background: #28a745;
    color: #fff;
  }

  .save-btn:hover {
    background: #1e7e34;
  }

  .delete-btn {
    background: #d9534f;
    color: #fff;
  }

  .delete-btn:hover {
    background: #b52b27;
  }
}

@media (max-width: 768px) {
  #ordersTable tr {
    margin-bottom: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 15px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 6px solid transparent; /* –∞–∫—Ü–µ–Ω—Ç–Ω–∞ –ª—ñ–Ω—ñ—è */
  }

  #ordersTable tr:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
  }

  /* –°—Ç–∞—Ç—É—Å–∏ */
  #ordersTable tr.status-paid {
    border-left-color: #28a745; /* –∑–µ–ª–µ–Ω–∏–π */
  }

  #ordersTable tr.status-pending {
    border-left-color: #ffc107; /* –∂–æ–≤—Ç–∏–π */
  }

  #ordersTable tr.status-cancelled {
    border-left-color: #dc3545; /* —á–µ—Ä–≤–æ–Ω–∏–π */
  }

  /* –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å—É */
  .order-status {
    font-weight: 600;
    padding: 6px 10px;
    border-radius: 6px;
    display: inline-block;
    margin-top: 8px;
  }

  .order-status.paid {
    background: #28a745;
    color: #fff;
  }

  .order-status.pending {
    background: #ffc107;
    color: #333;
  }

  .order-status.cancelled {
    background: #dc3545;
    color: #fff;
  }
}
  </style>
</head>
<body>

<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è -->
<div class="login-box" id="loginBox">
  <h2>–í—Ö—ñ–¥</h2>
  <form onsubmit="login(); return false;">
    <input type="text" id="username" placeholder="–õ–æ–≥—ñ–Ω" required autocomplete="username">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required autocomplete="current-password">
    <button type="submit">–£–≤—ñ–π—Ç–∏</button>
  </form>
    <p id="loginError"></p>
</div>



<!-- –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å -->
<div id="adminPanel">
  <h1>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

  <!-- –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
  <div class="controls">
    <label for="filterDate">–§—ñ–ª—å—Ç—Ä –∑–∞ –¥–∞—Ç–æ—é:</label>
    <input type="date" id="filterDate" name="filterDate">
    <button type="button" onclick="filterOrders()">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>

    <label for="searchInput">–ü–æ—à—É–∫:</label>
    <input type="text" id="searchInput" name="searchInput" placeholder="–Ü–º‚Äô—è –∞–±–æ —Ç–µ–ª–µ—Ñ–æ–Ω">
    <button type="button" onclick="searchOrders()">–ü–æ—à—É–∫</button>

    <button type="button" onclick="exportToExcel()">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤ Excel</button>
    <button type="button" onclick="exportToXLSX()">–ï–∫—Å–ø–æ—Ä—Ç —É XLSX</button>
    <button type="button" onclick="exportToPDF()">–ï–∫—Å–ø–æ—Ä—Ç —É PDF</button>
  </div>

  <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É -->
  <div class="edit-form">
    <form id="editProductForm" enctype="multipart/form-data">
      <label>–ù–æ–≤–µ —Ñ–æ—Ç–æ:</label>
      <input type="file" name="imeiges"><br>

      <label>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ:</label>
      <input type="file" id="fileInput" name="imeiges" />
      <button type="button" onclick="uploadFile()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button><br>

      <label>–ù–æ–≤–∞ —Ü—ñ–Ω–∞:</label>
      <input type="number" name="price" step="0.01"><br>

      <button type="button" onclick="updateProduct(1)">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </form>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ –µ–∫—Å–ø–æ—Ä—Ç—É -->
  <div class="export-buttons">
    <button type="button" onclick="exportToXLSX()">–ï–∫—Å–ø–æ—Ä—Ç —É—Å—ñ—Ö —É XLSX</button>
    <button type="button" onclick="exportToPDF()">–ï–∫—Å–ø–æ—Ä—Ç —É—Å—ñ—Ö —É PDF</button>
    <button type="button" onclick="exportToXLSX(true)">–ï–∫—Å–ø–æ—Ä—Ç –≤–∏–±—Ä–∞–Ω–∏—Ö —É XLSX</button>
    <button type="button" onclick="exportToPDF(true)">–ï–∫—Å–ø–æ—Ä—Ç –≤–∏–±—Ä–∞–Ω–∏—Ö —É PDF</button>
    <button type="button" onclick="toggleSelectAll(true)">–í–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ</button>
    <button type="button" onclick="toggleSelectAll(false)">–ó–Ω—è—Ç–∏ –≤—Å—ñ</button>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü—è –∑–∞–º–æ–≤–ª–µ–Ω—å -->
  <table id="ordersTable">
    <thead>
      <tr>
        <th scope="col">–§–æ—Ç–æ</th>
        <th scope="col">–Ü–º‚Äô—è</th>
        <th scope="col">–¢–µ–ª–µ—Ñ–æ–Ω</th>
        <th scope="col">Email</th>
        <th scope="col">–î–æ—Å—Ç–∞–≤–∫–∞</th>
        <th scope="col">–ú—ñ—Å—Ç–æ</th>
        <th scope="col">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</th>
        <th scope="col">‚Ññ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</th>
        <th scope="col">–û–ø–ª–∞—Ç–∞</th>
        <th scope="col">–¢–æ–≤–∞—Ä–∏</th>
        <th scope="col">–°—É–º–∞</th>
        <th scope="col">–î–∞—Ç–∞</th>
        <th scope="col">–î—ñ—ó</th>
      </tr>
    </thead>
    <tbody>
      <!-- —Ä—è–¥–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω—å –±—É–¥—É—Ç—å –¥–æ–¥–∞–≤–∞—Ç–∏—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
    </tbody>
  </table>
</div>


  
 <script>
  
 // ===== –ö–æ–Ω—Ñ—ñ–≥ =====
const CONFIG = {
  API_URL: 'http://localhost:3000/admin/orders',
  LOGIN_URL: 'http://localhost:3000/api/admin/login',
  ORDER_URL: 'http://localhost:3000/api/orders'
};

let allOrders = [];

// ===== –î–æ–ø–æ–º—ñ–∂–Ω—ñ =====
const getToken = () => localStorage.getItem('token');

const handleError = (err, errorMsg) => {
  console.error(errorMsg, err);
  showMessage('loginError', errorMsg, 'red');
};

const showMessage = (elementId, message, color = 'black') => {
  const el = document.getElementById(elementId);
  if (el) {
    el.textContent = message;
    el.style.color = color;
  }
};

const showTableError = msg => {
  document.querySelector('#ordersTable tbody').innerHTML =
    `<tr><td colspan="13" style="color:red;text-align:center;">${msg}</td></tr>`;
};

// ===== –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ =====
const checkToken = async () => {
  const token = getToken();
  if (!token) {
    console.warn("‚ö†Ô∏è –¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —É localStorage");
    return;
  }

  try {
    const res = await fetch(CONFIG.API_URL, {
      method: 'GET',
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();
    if (res.ok && Array.isArray(data)) {
      console.log("‚úÖ –¢–æ–∫–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π, –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:", data.length);
      console.log("üîë –¢–æ–∫–µ–Ω —É localStorage:", token);
    } else {
      console.error("‚ùå –¢–æ–∫–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∞–±–æ –¥–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ:", data);
    }
  } catch (err) {
    handleError(err, "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞");
  }
};

// ===== –ó–∞–ø–∏—Ç–∏ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ =====
const sendRequest = async (url, method = 'GET', body = null) => {
  const token = getToken();

  const headers = {
    ...(token && { Authorization: `Bearer ${token}` }),
    ...(body && { 'Content-Type': 'application/json' })
  };

  const options = {
    method,
    headers,
    ...(body && { body: JSON.stringify(body) })
  };

  try {
    const res = await fetch(url, options);

    console.log(`üì° –ó–∞–ø–∏—Ç: ${method} ${url}`);
    console.log("üì° –°—Ç–∞—Ç—É—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:", res.status);

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`HTTP ${res.status}: ${errorText}`);
    }

    const data = await res.json();
    console.log("üì¶ –°–∏—Ä—ñ –¥–∞–Ω—ñ –∑ –±–µ–∫–µ–Ω–¥—É:", data);

    return data;
  } catch (err) {
    handleError(err, "‚ùå –ü–æ–º–∏–ª–∫–∞ —É sendRequest");
    throw err;
  }
};

// ===== –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è =====
const login = async () => {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  try {
    const res = await fetch(CONFIG.LOGIN_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    if (!res.ok) throw new Error('Login failed');

    const { token } = await res.json();
    localStorage.setItem('token', token);

    togglePanels(true);
    await loadOrders();
  } catch (err) {
    handleError(err, '–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å');
  }
};

// ===== UI =====
const togglePanels = isLoggedIn => {
  document.getElementById('loginBox').style.display = isLoggedIn ? 'none' : 'block';
  document.getElementById('adminPanel').style.display = isLoggedIn ? 'block' : 'none';
};
// ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ =====
const ORDER_KEYS = ["photo","name","phone","email","delivery","city","branch","branchNumber","payment","items","total","date"];
let currentPage = 1;
const rowsPerPage = 10;
let sortDirection = true;

// ===== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å =====
async function loadOrders() {
  try {
    const token = getToken();
    const res = await fetch(CONFIG.API_URL, {
      cache: 'no-store',
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });

    if (!res.ok) throw new Error(`–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å: ${res.status}`);

    const data = await res.json();
    allOrders = Array.isArray(data) ? data : [];
    renderPaginatedOrders(allOrders);
    showMessage("loginError", `‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑–∞–º–æ–≤–ª–µ–Ω—å: ${allOrders.length}`, "green");
  } catch (err) {
    handleError(err, "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚ùå");
  }
}

// ===== –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ñ =====
function renderOrders(orders) {
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";

  orders.forEach(order => {
    const itemsHtml = Array.isArray(order.items)
      ? order.items.map(item => `
          <div class="order-item">
            <img src="http://localhost:3000${item.photo}" width="80" alt="${item.name}">
            <span>${item.name} ‚Äî ${item.price} –≥—Ä–Ω √ó ${item.quantity}</span>
          </div>
        `).join("")
      : typeof order.items === "string"
        ? `<span>${order.items}</span>`
        : `<span>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</span>`;

    tbody.innerHTML += `
      <tr data-id="${order.id}">
        <td>${itemsHtml}</td>
        <td>${order.name}</td>
        <td>${order.phone}</td>
        <td>${order.email}</td>
        <td>${order.delivery}</td>
        <td>${order.city}</td>
        <td>${order.branch}</td>
        <td>${order.branchNumber}</td>
        <td>${order.payment}</td>
        <td>${order.total}</td>
        <td>${order.date}</td>
        <td>
          <button onclick="editOrder('${order.id}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
          <button onclick="deleteOrder('${order.id}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </td>
      </tr>
    `;
  });
}

// ===== CRUD =====
const createOrder = async (items, customer) => {
  try {
    await sendRequest(CONFIG.ORDER_URL, 'POST', { items, customer });
    showMessage('loginError', '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ ‚úÖ', 'green');
    await loadOrders();
  } catch (err) {
    handleError(err, '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ ‚ùå');
  }
};

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
const saveOrder = async id => {
  const row = document.querySelector(`#ordersTable tbody tr[data-id="${id}"]`);
  if (!row) return;

  await updateOrder(id, row, allOrders);
};


  
async function updateOrder(id, row, allOrders) {
  const updatedOrder = {
    name: row.cells[1].textContent.trim(),
    phone: row.cells[2].textContent.trim(),
    email: row.cells[3].textContent.trim(),
    delivery: row.cells[4].textContent.trim(),
    city: row.cells[5].textContent.trim(),
    branch: row.cells[6].textContent.trim(),
    branchNumber: row.cells[7].textContent.trim(),
    payment: row.cells[8].textContent.trim(),
    total: row.cells[10].textContent.trim(),
    date: row.cells[11].textContent.trim(),
    photo: allOrders.find(o => String(o.id) === String(id))?.photo,
    items: allOrders.find(o => String(o.id) === String(id))?.items || []
  };

  try {
    await sendRequest(`${CONFIG.API_URL}/${id}`, 'PUT', updatedOrder);
    showMessage('loginError', '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ', 'green');
    await loadOrders();
  } catch (err) {
    handleError(err, '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ ‚ùå');
  }
}

const deleteOrder = async id => {
  if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?')) return;
  try {
    await sendRequest(`${CONFIG.API_URL}/${id}`, 'DELETE');
    showMessage('loginError', '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ üóëÔ∏è', 'green');
    await loadOrders();
  } catch (err) {
    if (err.message.includes('404')) {
      showMessage('loginError', '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∂–µ –±—É–ª–æ –≤–∏–¥–∞–ª–µ–Ω–æ üóëÔ∏è', 'orange');
      await loadOrders();
    } else {
      handleError(err, '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ ‚ùå');
    }
  }
};
// ===== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ =====
async function uploadFile() {
  const fileInput = document.getElementById("fileInput");
  if (!fileInput?.files.length) {
    alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª!");
    return;
  }

  const formData = new FormData();
  formData.append("imeiges", fileInput.files[0]);

  try {
    const res = await fetch("http://localhost:3000/upload", { method: "POST", body: formData });
    if (!res.ok) throw new Error(`–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`);

    const data = await res.json();
    if (data.success && data.file?.path) {
      alert("–§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ ‚úÖ");
      return data.file.path;
    } else {
      alert(data.message || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ‚ùå");
    }
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ:", err);
    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ");
  }
}

// ===== –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è =====
const sortTable = (columnIndex) => {
  const key = ORDER_KEYS[columnIndex];
  const sorted = [...allOrders].sort((a, b) => {
    const valA = a[key] ?? "";
    const valB = b[key] ?? "";
    if (!isNaN(valA) && !isNaN(valB)) {
      return sortDirection ? valA - valB : valB - valA;
    }
    return sortDirection
      ? valA.toString().localeCompare(valB.toString())
      : valB.toString().localeCompare(valA.toString());
  });
  sortDirection = !sortDirection;
  renderPaginatedOrders(sorted);
};

document.querySelectorAll("#ordersTable th").forEach((th, index) => {
  th.addEventListener("click", () => sortTable(index));
});

// ===== –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è =====
const renderPaginatedOrders = (orders) => {
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  renderOrders(orders.slice(start, end));
  renderPaginationControls(orders.length);
};

const renderPaginationControls = (totalRows) => {
  const totalPages = Math.ceil(totalRows / rowsPerPage);
  let controls = document.getElementById("paginationControls");
  if (!controls) {
    controls = document.createElement("div");
    controls.id = "paginationControls";
    controls.className = "pagination";
    document.getElementById("adminPanel").appendChild(controls);
  }
  controls.innerHTML = `
    <button onclick="changePage(-1)" ${currentPage === 1 ? "disabled" : ""}>–ü–æ–ø–µ—Ä–µ–¥–Ω—è</button>
    <span>–°—Ç–æ—Ä—ñ–Ω–∫–∞ ${currentPage} –∑ ${totalPages}</span>
    <button onclick="changePage(1)" ${currentPage === totalPages ? "disabled" : ""}>–ù–∞—Å—Ç—É–ø–Ω–∞</button>
  `;
};

const changePage = (direction) => {
  const totalPages = Math.ceil(allOrders.length / rowsPerPage);
  currentPage = Math.min(Math.max(1, currentPage + direction), totalPages);
  renderPaginatedOrders(allOrders);
};



// ===== –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—É–º–∏ =====
const updateTotal = (id) => {
  const row = document.querySelector(`#ordersTable tr[data-id="${id}"]`);
  if (!row) return;
  const price = parseFloat(row.querySelector(".price")?.textContent) || 0;
  const quantity = parseInt(row.querySelector(".quantity")?.textContent) || 0;
  const totalCell = row.querySelector(`#total-${id}`);
  if (totalCell) totalCell.textContent = (price * quantity).toFixed(2);
};


// ===== –í–∏–±—Ä–∞—Ç–∏ / –∑–Ω—è—Ç–∏ –≤—Å—ñ —á–µ–∫–±–æ–∫—Å–∏ =====
const toggleSelectAll = (checked) => {
  document.querySelectorAll('.order-checkbox').forEach(cb => {
    cb.checked = checked;
  });
};
</script>