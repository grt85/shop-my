<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Адмін-панель замовлень</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    input[type="date"], input[type="text"], button {
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #0078d7;
      color: white;
      cursor: pointer;
      border: none;
    }

    button:hover {
      background-color: #005fa3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #0078d7;
      color: white;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }

      td::before {
        content: attr(data-label);
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }

      th {
        display: none;
      }
    }
  </style>
</head>
<body>
  <script>
    const allowedUsers = {
      admin: '1717',
      manager: '1717'
    };

    const username = prompt('Введіть логін (admin або manager):');
    const password = prompt('Введіть пароль:');

    if (!allowedUsers[username] || allowedUsers[username] !== password) {
      document.body.innerHTML = '<h2 style="text-align:center;color:red;">Доступ заборонено</h2>';
      throw new Error('Невірний логін або пароль');
    }
  </script>

  <h1>Замовлення</h1>

  <div class="controls">
    <input type="date" id="filterDate">
    <input type="text" id="searchInput" placeholder="Пошук по імені або телефону">
    <button onclick="filterOrders()">Фільтрувати</button>
    <button onclick="searchOrders()">Пошук</button>
    <button onclick="exportToExcel()">Експортувати в Excel</button>
  </div>

  <table id="ordersTable">
    <thead>
      <tr>
        <th>Ім’я</th>
        <th>Телефон</th>
        <th>Email</th>
        <th>Доставка</th>
        <th>Товари</th>
        <th>Дата</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

 <script>
  let allOrders = [];

  // Завантаження замовлень
  fetch('http://localhost:3000/admin/orders')
    .then(res => res.text())
    .then(text => {
      const rows = text.split('===========================').filter(r => r.trim());
      rows.forEach(row => {
        const name = row.match(/Ім’я: (.+)/)?.[1] || '';
        const phone = row.match(/Телефон: (.+)/)?.[1] || '';
        const email = row.match(/Email: (.+)/)?.[1] || '';
        const delivery = row.match(/Доставка: (.+)/)?.[1] || '';
        const items = row.match(/Товари: (.+)/)?.[1] || '';
        const date = row.match(/Дата: (.+)/)?.[1] || '';

        allOrders.push({ name, phone, email, delivery, items, date });
      });

      renderOrders(allOrders);
    })
    .catch(err => {
      document.body.innerHTML = '<h2 style="text-align:center;color:red;">Помилка завантаження замовлень</h2>';
      console.error(err);
    });

  // Відображення таблиці
  function renderOrders(orders) {
    const tbody = document.querySelector('#ordersTable tbody');
    tbody.innerHTML = '';
    orders.forEach(order => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Ім’я">${order.name}</td>
        <td data-label="Телефон">${order.phone}</td>
        <td data-label="Email">${order.email}</td>
        <td data-label="Доставка">${order.delivery}</td>
        <td data-label="Товари">${order.items}</td>
        <td data-label="Дата">${order.date}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Фільтр по даті
  function filterOrders() {
    const selectedDate = document.getElementById('filterDate').value;
    if (!selectedDate) return renderOrders(allOrders);

    const filtered = allOrders.filter(order => {
      const orderDate = new Date(order.date).toISOString().slice(0, 10);
      return orderDate === selectedDate;
    });

    renderOrders(filtered);
  }

  // Пошук по імені або телефону
  function searchOrders() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    if (!query) return renderOrders(allOrders);

    const filtered = allOrders.filter(order =>
      order.name.toLowerCase().includes(query) ||
      order.phone.toLowerCase().includes(query)
    );

    renderOrders(filtered);
  }

  // Експорт у Excel (CSV)
  function exportToExcel() {
    let csv = 'Ім’я,Телефон,Email,Доставка,Товари,Дата\n';
    allOrders.forEach(o => {
      csv += `"${o.name}","${o.phone}","${o.email}","${o.delivery}","${o.items}","${o.date}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'orders.csv';
    link.click();
  }
</script>
</body>
</html>